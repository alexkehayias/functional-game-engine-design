<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Functional Game Engine Design</title>
<meta name="author" content="(Alex Kehayias)"/>
<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/reveal.css"/>
<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/theme/sky.css" id="theme"/>
<link rel="stylesheet" href=""/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'http://cdn.jsdelivr.net/reveal.js/3.0.0/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
<meta name="description" content="Functional Game Engine Design"/><style>pre.src {background-color: #1B1D1E; color: #f8f8f0; padding: 15px;}</style>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1>Functional Game Engine Design</h1>
<h2>Alex Kehayias</h2>
<h2><a href="mailto:@alexkehayias">@alexkehayias</a></h2>
<h2></h2>
</section>

<section>
<section id="slide-orgheadline2">
<h2 id="orgheadline2">Init</h2>
<ul>
<li>You can build a game</li>
<li>You can build a game engine</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline1">
<h3 id="orgheadline1">They tend to be mutually exclusive&#x2026;</h3>
</section>
</section>
<section>
<section id="slide-orgheadline3">
<h2 id="orgheadline3">About me</h2>
<ul>
<li>I'm not a game developer</li>
<li>I'm not a "gamer"</li>
<li>I don't have a CS degree</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline4">
<h2 id="orgheadline4">But you should believe me anyway&#x2026;</h2>
<ul>
<li>I'm a self taught musician</li>
<li>I'm a self taught entrepreneur</li>
<li>I'm a self taught developer</li>
<li>I'm here to build worlds of my own vision</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline7">
<h2 id="orgheadline7">What is a game?</h2>
<div class="outline-text-2" id="text-orgheadline7">
</div></section>
</section>
<section>
<section id="slide-orgheadline5">
<h3 id="orgheadline5">STATE!</h3>
<ul>
<li>The only thing that matters</li>
<li>The state is the game is the fun</li>
<li>Games are state transitions at 60 FPS</li>
<li>Games are complicated (lots of moving parts)</li>
<li>Writing games can be less complex (less intertwined parts)</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline6">
<h3 id="orgheadline6">Game == Statetime</h3>

<div class="figure">
<p><img src="./statetime.png" alt="statetime.png" />
</p>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline10">
<h2 id="orgheadline10">Why another game engine? Why not use Unity/CryEngine/etc?</h2>
<div class="outline-text-2" id="text-orgheadline10">
</div></section>
</section>
<section>
<section id="slide-orgheadline8">
<h3 id="orgheadline8">Because it's art</h3>
</section>
</section>
<section>
<section id="slide-orgheadline9">
<h3 id="orgheadline9">Also it's fun!!</h3>
</section>
</section>
<section>
<section id="slide-orgheadline11">
<h2 id="orgheadline11">Goals for a functional game engine</h2>
<ul>
<li>Modularity in adding new features and content</li>
<li>Make how the game runs declarative</li>
<li>Unit testable by mocking data only</li>
<li>Functional purity (mostly!)</li>
<li>No global state access</li>
<li>REPL driven and inspect-able</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline12">
<h2 id="orgheadline12">Example</h2>
<div class="org-src-container">

<pre  class="src src-java">  <span style="color: #465457;">// </span><span style="color: #465457;">Example taken from http://www.gamedev.net/page/resources/_/technical/game-programming/making-a-game-engine-core-design-principles-r3210</span>
  <span style="color: #465457;">// </span><span style="color: #465457;">A Game object that iterates over each entity and induces side effects</span>
  <span style="color: #f92672; font-weight: bold;">class</span> <span style="color: #66d9ef; font-weight: bold;">Game</span>
  {
  <span style="color: #66d9ef; font-weight: bold;">Player</span> <span style="color: color-152;">player</span>;
      <span style="color: #66d9ef; font-weight: bold;">Enemy</span>[] <span style="color: color-152;">enemies</span>;

      <span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">update</span>()
      {
      <span style="color: color-152;">foreach</span> (Enemy enemy <span style="color: #66d9ef; font-weight: bold;">in</span> <span style="color: color-152;">enemies</span>)
          {
          <span style="color: #f92672; font-weight: bold;">if</span> (Math.abs(enemy.y - player.y) &lt; EnemySightRange &amp;&amp; Math.abs(enemy.x - player.x))
              {
              enemy.moveTowards(player.x, player.y);
              }
          }

          <span style="color: #f92672; font-weight: bold;">if</span> (input.keyDown(<span style="color: #e6db74;">'left'</span>))
          {
          player.move(-1, 0);
          }
          <span style="color: #465457;">// </span><span style="color: #465457;">... rest of player logic</span>
      }

      <span style="color: #66d9ef; font-weight: bold;">void</span> <span style="color: #a6e22e;">draw</span>()
      {
      player.draw();
      <span style="color: color-152;">foreach</span> (Enemy enemy <span style="color: #66d9ef; font-weight: bold;">in</span> <span style="color: color-152;">enemies</span>)
          {
          enemy.draw();
          }
      }
  }
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline13">
<h2 id="orgheadline13">Functional example</h2>
<div class="org-src-container">

<pre  class="src src-clojure">  <span style="color: #465457;">;; </span><span style="color: #465457;">Reduce the game state over a collection of functions to get the next frame</span>
  <span style="color: #8c8c8c;">(</span>reduce (fn [accum f] <span style="color: #8c8c8c;">(</span>f accum<span style="color: #8c8c8c;">))</span>
          state
          [f1 f2 f3 f4]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline14">
<h2 id="orgheadline14">Modularity</h2>
</section>
</section>
<section>
<section id="slide-orgheadline15">
<h2 id="orgheadline15">Class hierarchies for modeling games</h2>

<div class="figure">
<p><img src="./class_hierarchy.png" alt="class_hierarchy.png" />
</p>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline16">
<h2 id="orgheadline16">Class hierarchies for modeling games</h2>
<ul>
<li>Initially expresses the problem domain succinctly</li>
<li>As code bases grows and changes more ambiguity around overrides, sub classing, and cascading breaking changes</li>
<li>Dreaded "deadly diamond of death"</li>
<li>Which override overrides the override again?</li>
<li>Reusability vs decoupling</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline17">
<h2 id="orgheadline17">Entity Component System</h2>
<ul>
<li>Originates from the development of Dungeon Siege for use with online multiplayer demands</li>
<li>Popularized by the Unity game engine</li>
<li>Decouples object hierarchies and focuses on collections of aspects and the means of iterating over theme</li>
<li>Easily add, remove, synthesise new things from reusable components</li>
<li>Pairs well with functional programming techniques!</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline18">
<h2 id="orgheadline18">Component based modeling</h2>

<div class="figure">
<p><img src="./component_modeling.png" alt="component_modeling.png" />
</p>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline23">
<h2 id="orgheadline23">How it works</h2>
<div class="outline-text-2" id="text-orgheadline23">
</div></section>
</section>
<section>
<section id="slide-orgheadline19">
<h3 id="orgheadline19">Entity</h3>
<div class="org-src-container">

<pre  class="src src-clojure">{<span style="color: #ae81ff;">:player1</span> [<span style="color: #ae81ff;">:controllable</span> <span style="color: #ae81ff;">:moveable</span> <span style="color: #ae81ff;">:collidable</span>]}
</pre>
</div>
<ul>
<li>A label</li>
<li>A collection of component labels</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline20">
<h3 id="orgheadline20">Component</h3>
<div class="org-src-container">

<pre  class="src src-clojure">{<span style="color: #ae81ff;">:moveable</span> f}
</pre>
</div>
<ul>
<li>A label</li>
<li>A function of state</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline21">
<h3 id="orgheadline21">System</h3>
<div class="org-src-container">

<pre  class="src src-clojure">{<span style="color: #ae81ff;">:movement</span> f}
</pre>
</div>
<ul>
<li>A label</li>
<li>A function of state</li>
<li>Operates on a collection of entities that have a given component ID, or not</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline22">
<h3 id="orgheadline22">Scene</h3>
<div class="org-src-container">

<pre  class="src src-clojure">{<span style="color: #ae81ff;">:title-screen</span> [<span style="color: #ae81ff;">:main-menu</span> <span style="color: #ae81ff;">:input</span>]
 <span style="color: #ae81ff;">:game</span> [<span style="color: #ae81ff;">:input</span> <span style="color: #ae81ff;">:movement</span> <span style="color: #ae81ff;">:ai</span>]}
</pre>
</div>
<ul>
<li>A label</li>
<li>A collection of system labels in the order systems should be executed</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline24">
<h2 id="orgheadline24">Seeing a pattern here?</h2>
<ul>
<li>It's all data</li>
<li>It's all values</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline25">
<h2 id="orgheadline25">Gameoiconicity?</h2>
<ul>
<li>Game is data, data is game</li>
<li>Game can rewrite the game during game time</li>

</ul>
<p>
dynamic as <i>fuck</i>!&#x2026;
</p>
</section>
</section>
<section>
<section id="slide-orgheadline26">
<h2 id="orgheadline26">Implementation</h2>
<p>
Game state is a data structure, like a database
</p>
<div class="org-src-container">

<pre  class="src src-clojure">{}
</pre>
</div>
<p>
All state, functions, and execution order is queried from state at game time
</p>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>get-in state [<span style="color: #ae81ff;">:systems</span> <span style="color: #ae81ff;">:movement</span>]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<p>
The game loop recursively calls a function of state
</p>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>f <span style="color: #8c8c8c;">(</span>f state<span style="color: #8c8c8c;">))</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline27">
<h2 id="orgheadline27">Implementation</h2>
<p>
The game function reduces over all system functions
</p>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>reduce (fn [state f] <span style="color: #8c8c8c;">(</span>f state<span style="color: #8c8c8c;">))</span> init-state [s1 s2 s3 s4]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<p>
A system function reduces over entities that participate in a component
</p>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>reduce f state entity-ids<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<p>
A component function takes state and returns new state modified for that entity ID only
</p>
<div class="org-src-container">

<pre  class="src src-clojure">(fn [state] ...<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline28">
<h2 id="orgheadline28">Basically, everything is a function of the overall game state</h2>
</section>
</section>
<section>
<section id="slide-orgheadline29">
<h2 id="orgheadline29">The good</h2>
<ul>
<li>Can be easily expressed with pure functions</li>
<li>Easy to reason about</li>
<li>Parallelize-able</li>
<li>No side-effects</li>
<li>Dynamic</li>
<li>No objects</li>
<li>Easy to add/remove new functionality without rewriting other code</li>
<li>Declarative</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline30">
<h2 id="orgheadline30">The bad</h2>
<ul>
<li>Everyone has access to everything everywhere</li>
<li>What happens when you need parameterization?</li>
<li>Need implementation details about the shape of the data (state)</li>
<li>Performance (more on that later)</li>
<li>What if I need a component to behave different depending on who it is?</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline31">
<h2 id="orgheadline31">We need more sugar!</h2>
</section>
</section>
<section>
<section id="slide-orgheadline32">
<h2 id="orgheadline32">Principle of least privilege (of state)</h2>
<ul>
<li>Only have access to what you need</li>
<li>Only can change what belongs to you</li>
<li>Make it easy to do the right thing</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline33">
<h2 id="orgheadline33">Lenses</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>combine-fn <span style="color: #8c8c8c;">(</span>body-fn <span style="color: #8c8c8c;">(</span>args-fn input<span style="color: #8c8c8c;">)))</span>
</pre>
</div>
<ul>
<li>A way of isolating wider inputs to a function</li>
<li>Prevents access to things the functions doesn't care about</li>
<li>Eliminates the need for common call signatures</li>
<li>Implementation details hidden from the body-fn</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline34">
<h2 id="orgheadline34">Lense Example</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">lense</span> [args-f body-f combine-f]
  (fn [input]
    <span style="color: #8c8c8c;">(</span>combine-f input <span style="color: #8c8c8c;">(</span>body-f <span style="color: #8c8c8c;">(</span>args-f input<span style="color: #8c8c8c;">)))))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">def</span> <span style="color: color-152;">component-fn</span>
  <span style="color: #8c8c8c;">(</span>lense (fn [state] <span style="color: #8c8c8c;">(</span>get state <span style="color: #ae81ff;">:foo</span><span style="color: #8c8c8c;">))</span>
         (fn [component-state] <span style="color: #8c8c8c;">(</span>update component-state <span style="color: #ae81ff;">:x</span> inc<span style="color: #8c8c8c;">))</span>
         (fn [state results] <span style="color: #8c8c8c;">(</span>assoc state <span style="color: #ae81ff;">:foo</span> results<span style="color: #8c8c8c;">))))</span>
</pre>
</div>
<p>
The body function is isolated from knowing anything about the input data
</p>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>component-fn {<span style="color: #ae81ff;">:renderer</span> {} <span style="color: #ae81ff;">:stuff</span> {} <span style="color: #ae81ff;">:foo</span> {<span style="color: #ae81ff;">:x</span> 1}}<span style="color: #8c8c8c;">)</span>
&gt;&gt; {<span style="color: #ae81ff;">:renderer</span> {} <span style="color: #ae81ff;">:stuff</span> {} <span style="color: #ae81ff;">:foo</span> {<span style="color: #ae81ff;">:x</span> 2}}
</pre>
</div>
<p>
Component function is called with the entire state as input
</p>
</section>
</section>
<section>
<section id="slide-orgheadline35">
<h2 id="orgheadline35">Now we can focus on one aspect using pure functions</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">component-f</span>
  <span style="color: #465457;">;; </span><span style="color: #465457;">Default args, but can be customized when declaring the component</span>
  [entity-id component-state opts]
  <span style="color: #465457;">;; </span><span style="color: #465457;">Returns updated component state</span>
  <span style="color: #8c8c8c;">(</span>body ...<span style="color: #8c8c8c;">))</span>

<span style="color: #465457;">;; </span><span style="color: #465457;">Wrapped with mk-component-fn it returns a function that takes</span>
<span style="color: #465457;">;; </span><span style="color: #465457;">game state and entity-id as arguments</span>
<span style="color: #8c8c8c;">((</span>mk-component-fn <span style="color: #ae81ff;">:component-1</span> component-f<span style="color: #8c8c8c;">)</span> state <span style="color: #ae81ff;">:player1</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>
<ul>
<li>mk-component-fn is a lense</li>
<li>By default, the lense calls the component function with just the state it needs</li>
<li>To customize, provide an :args-fn and :format-fn to mk-component-fn options</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline36">
<h2 id="orgheadline36">Polymorphism</h2>
<ul>
<li>By passing in an entity ID we can make a decision about what the component should do</li>
<li>multimethods, protocols, conditionals to handle different implementations of the same component</li>
<li>As long as it follows the component fn spec, it will work</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline37">
<h2 id="orgheadline37">Polymorphism example</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #465457;">;; </span><span style="color: #465457;">Dispatch on the entity-id</span>
<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmulti</span> <span style="color: #a6e22e;">move</span> (fn [entity-id &amp; args] entity-id<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmethod</span> <span style="color: #a6e22e;">move</span> <span style="color: #ae81ff;">:default</span>
  (fn [_ component-state opts]
    <span style="color: #8c8c8c;">(</span>body ...<span style="color: #8c8c8c;">)))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmethod</span> <span style="color: #a6e22e;">move</span> <span style="color: #ae81ff;">:player1</span>
  (fn [_ component-state opts]
    <span style="color: #8c8c8c;">(</span>update component-state <span style="color: #ae81ff;">:pos</span> #<span style="color: #8c8c8c;">(</span>map inc <span style="color: color-152;">%</span><span style="color: #8c8c8c;">))))</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline43">
<h2 id="orgheadline43">Sharing state ಠ_<sub>ಠ</sub></h2>
<ul>
<li>Games tend to have things that interact with each other</li>
<li>Share component state without tightly coupling</li>
<li>Read only access</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline38">
<h3 id="orgheadline38">Coupling</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">blob-component</span>
  [entity-id component-state opts]
  <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #8c8c8c;">(</span>get component-state <span style="color: #ae81ff;">:colliding?</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #8c8c8c;">(</span>collided-with-enemy? component-state<span style="color: #8c8c8c;">)</span>
      <span style="color: #8c8c8c;">(</span>update component-state <span style="color: #ae81ff;">:health</span> dec<span style="color: #8c8c8c;">)</span>
      <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #8c8c8c;">(</span>get component-state <span style="color: #ae81ff;">:moving?</span><span style="color: #8c8c8c;">)</span>
         <span style="color: #8c8c8c;">(</span>assoc component-state <span style="color: #ae81ff;">:offset</span> [0 0]<span style="color: #8c8c8c;">)</span>
         <span style="color: #8c8c8c;">(</span>assoc component-state <span style="color: #ae81ff;">:offset</span> <span style="color: #8c8c8c;">(</span>get component-state <span style="color: #ae81ff;">:move-offset</span><span style="color: #8c8c8c;">))))</span>
  component-state<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<ul>
<li>Solves communication between aspects by combining them into one component :(</li>
<li>Couples movement, collision, and health together with state flags</li>
<li>Conditional logic exponentially increases branching paths</li>
<li>To add a new feature/aspect we potentially break other paths</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline39">
<h3 id="orgheadline39">Use an event queue</h3>
<ul>
<li>Solves cross component communication</li>
<li>Solves cross entity communication</li>
<li>Loose coupling (still need to know shape of data)</li>
<li>Any component can emit a message with an event ID</li>
<li>Any component can subscribe to messages matching the event ID</li>
<li>By default, message inbox is provided in the last arg to the component function</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline40">
<h3 id="orgheadline40">Events implementation</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">get-events</span>
  [state selectors]
  <span style="color: #8c8c8c;">(</span>get-in state selectors<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">mk-event</span>
  [msg selectors]
  {<span style="color: #ae81ff;">:event-id</span> <span style="color: #8c8c8c;">(</span>first selectors<span style="color: #8c8c8c;">)</span> <span style="color: #ae81ff;">:selectors</span> selectors <span style="color: #ae81ff;">:msg</span> msg}<span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">emit-event</span>
  [state msg selectors]
  <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">let</span> [event <span style="color: #8c8c8c;">(</span>mk-event msg selectors<span style="color: #8c8c8c;">)</span>]
    <span style="color: #8c8c8c;">(</span>update-in state selectors conj event<span style="color: #8c8c8c;">)))</span>
</pre>
</div>
<p>
Example
</p>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>emit-event {} {<span style="color: #ae81ff;">:foo</span> <span style="color: #ae81ff;">:bar</span>} [<span style="color: #ae81ff;">:collision</span> <span style="color: #ae81ff;">:player1</span>]<span style="color: #8c8c8c;">)</span>
&gt;&gt; {<span style="color: #ae81ff;">:collision</span>
..   {<span style="color: #ae81ff;">:player1</span>
..     [{<span style="color: #ae81ff;">:event-id</span> <span style="color: #ae81ff;">:collision</span>,
..       <span style="color: #ae81ff;">:selectors</span> [<span style="color: #ae81ff;">:collision</span> <span style="color: #ae81ff;">:player1</span>],
..       <span style="color: #ae81ff;">:msg</span> {<span style="color: #ae81ff;">:foo</span> <span style="color: #ae81ff;">:bar</span>}}]}}
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline41">
<h3 id="orgheadline41">Using events</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">collision</span>
  [entity-id component-state opts]
  <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if-let</span> [collider <span style="color: #8c8c8c;">(</span>colliding? component-state<span style="color: #8c8c8c;">)</span>]
    [component-state <span style="color: #8c8c8c;">(</span>mk-event {<span style="color: #ae81ff;">:colliding</span> collider} [<span style="color: #ae81ff;">:collision</span> entity-id]<span style="color: #8c8c8c;">)</span>]
    component-state<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">movement</span>
  [entity-id component-state {<span style="color: #ae81ff;">:keys</span> [inbox]}]
  <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #8c8c8c;">(</span>collision-event? inbox<span style="color: #8c8c8c;">)</span>
    [component-state <span style="color: #8c8c8c;">(</span>mk-event {<span style="color: #ae81ff;">:offset-x</span> 0 <span style="color: #ae81ff;">:offset-y</span> 0} [<span style="color: #ae81ff;">:move-change</span> entity-id]<span style="color: #8c8c8c;">)</span>]
    component-state<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">position</span>
  [entity-id component-state {<span style="color: #ae81ff;">:keys</span> [inbox]}]
  <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if-let</span> <span style="color: #8c8c8c;">(</span>move-event? inbox<span style="color: #8c8c8c;">)</span>
    <span style="color: #8c8c8c;">(</span>update component-state <span style="color: #ae81ff;">:pos</span> <span style="color: #8c8c8c;">(</span>calculate-coords inbox<span style="color: #8c8c8c;">))</span>
    component-state<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">health</span>
  [entity-id component-state {<span style="color: #ae81ff;">:keys</span> [inbox]}]
  <span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">if-let</span> <span style="color: #8c8c8c;">(</span>enemy-collision-event? inbox<span style="color: #8c8c8c;">)</span>
    <span style="color: #8c8c8c;">(</span>update component-state <span style="color: #ae81ff;">:hitpoints</span> dec<span style="color: #8c8c8c;">)</span>
    component-state<span style="color: #8c8c8c;">))</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline42">
<h3 id="orgheadline42">Using events</h3>
<ul>
<li>No longer need blob components that try to do everything</li>
<li>Moves the implementation of taking damage downstream</li>
<li>Provides a contract for any component to interact with another</li>
<li>Can implement new game mechanics (invinsibility, walk through walls, time stop)</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline44">
<h2 id="orgheadline44">Making the game declarative</h2>
<ul>
<li>Capture how the game runs in one place</li>
<li>Use the full tooling of higher order functions and data manipulation functions</li>
<li>Game engine needs to only interpret the spec</li>
<li>Doesn't matter who or how the spec is generated</li>
<li>No macros, just data</li>

</ul>
<p>
&#x2026;maybe macros later, for syntactic sugar only
</p>
</section>
</section>
<section>
<section id="slide-orgheadline45">
<h2 id="orgheadline45">Declarative game</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>mk-game-state
  <span style="color: #465457;">;; </span><span style="color: #465457;">Starting with an empty hashmap or an existing hashmap</span>
  {}
  <span style="color: #ae81ff;">:default</span> <span style="color: #465457;">;; </span><span style="color: #465457;">What scene ID to start with</span>
  <span style="color: #465457;">;; </span><span style="color: #465457;">A scene with an ID of :default that has a collection of systems</span>
  <span style="color: #465457;">;; </span><span style="color: #465457;">to be called in sequential order</span>
  [<span style="color: #ae81ff;">:scene</span> <span style="color: #ae81ff;">:default</span> [<span style="color: #ae81ff;">:input</span>
                    <span style="color: #ae81ff;">:movement</span>
                    <span style="color: #ae81ff;">:animate</span>
                    <span style="color: #ae81ff;">:render</span>
                    <span style="color: #ae81ff;">:events</span>]]
  <span style="color: #465457;">;; </span><span style="color: #465457;">Event system to be used for inter component communication</span>
  [<span style="color: #ae81ff;">:system</span> <span style="color: #ae81ff;">:events</span> event-system]
  <span style="color: #465457;">;; </span><span style="color: #465457;">Updates the user input from keyboard</span>
  [<span style="color: #ae81ff;">:system</span> <span style="color: #ae81ff;">:input</span> input-system]
  <span style="color: #465457;">;; </span><span style="color: #465457;">Render system for drawing sprites</span>
  [<span style="color: #ae81ff;">:system</span> <span style="color: #ae81ff;">:render</span> render-system]
  <span style="color: #465457;">;; </span><span style="color: #465457;">Animation system for animating sprites</span>
  [<span style="color: #ae81ff;">:system</span> <span style="color: #ae81ff;">:animate</span> animation-system <span style="color: #ae81ff;">:animateable</span>]
  <span style="color: #465457;">;; </span><span style="color: #465457;">Animation component that subscribes to action events</span>
  [<span style="color: #ae81ff;">:component</span> <span style="color: #ae81ff;">:animateable</span>
   [animate {<span style="color: #ae81ff;">:args-fn</span> include-moveable-state
             <span style="color: #ae81ff;">:subscriptions</span> [<span style="color: #ae81ff;">:action</span>]}]]
  <span style="color: #465457;">;;</span>
  [<span style="color: #ae81ff;">:system</span> <span style="color: #ae81ff;">:movement</span> movement-system <span style="color: #ae81ff;">:moveable</span>]
  [<span style="color: #ae81ff;">:component</span> <span style="color: #ae81ff;">:moveable</span>
   [move {<span style="color: #ae81ff;">:subscriptions</span> [<span style="color: #ae81ff;">:move-change</span> <span style="color: #ae81ff;">:collision</span>]}]]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline46">
<h2 id="orgheadline46">Behavior is described with data, not code</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>mk-entity state
           <span style="color: #ae81ff;">:missle-1</span>
           <span style="color: #ae81ff;">:components</span> [[<span style="color: #ae81ff;">:explosive</span> {<span style="color: #ae81ff;">:hit-radius</span> 10}]
                        [<span style="color: #ae81ff;">:moveable</span> {<span style="color: #ae81ff;">:x</span> 20 <span style="color: #ae81ff;">:y</span> 100}]
                        [<span style="color: #ae81ff;">:heat-seeking</span> {<span style="color: #ae81ff;">:target</span> <span style="color: #ae81ff;">:player1</span> <span style="color: #ae81ff;">:velocity</span> 10}]]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline47">
<h2 id="orgheadline47">Interpreting the game spec</h2>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmulti</span> <span style="color: #a6e22e;">mk-state</span>
  (fn [state args] <span style="color: #8c8c8c;">(</span>first args<span style="color: #8c8c8c;">)))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmethod</span> <span style="color: #a6e22e;">mk-state</span> <span style="color: #ae81ff;">:entity</span>
  [state [_ &amp; args]]
  <span style="color: #8c8c8c;">(</span>apply <span style="color: #8c8c8c;">(</span>partial <span style="color: #66d9ef; font-weight: bold;">ces</span>/mk-entity state<span style="color: #8c8c8c;">)</span> args<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmethod</span> <span style="color: #a6e22e;">mk-state</span> <span style="color: #ae81ff;">:component</span>
  [state [_ &amp; args]]
  <span style="color: #8c8c8c;">(</span>apply <span style="color: #8c8c8c;">(</span>partial <span style="color: #66d9ef; font-weight: bold;">ces</span>/mk-component state<span style="color: #8c8c8c;">)</span> args<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmethod</span> <span style="color: #a6e22e;">mk-state</span> <span style="color: #ae81ff;">:system</span>
  [state [_ &amp; args]]
  <span style="color: #8c8c8c;">(</span>apply <span style="color: #8c8c8c;">(</span>partial <span style="color: #66d9ef; font-weight: bold;">ces</span>/mk-system state<span style="color: #8c8c8c;">)</span> args<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmethod</span> <span style="color: #a6e22e;">mk-state</span> <span style="color: #ae81ff;">:scene</span>
  [state [_ &amp; args]]
  <span style="color: #8c8c8c;">(</span>apply <span style="color: #8c8c8c;">(</span>partial <span style="color: #66d9ef; font-weight: bold;">ces</span>/mk-scene state<span style="color: #8c8c8c;">)</span> args<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">mk-game-state</span>
  [state init-scene-id &amp; specs]
  <span style="color: #8c8c8c;">(</span>reduce (fn [accum args] <span style="color: #8c8c8c;">(</span>mk-state accum args<span style="color: #8c8c8c;">))</span>
          <span style="color: #8c8c8c;">(</span>assoc-in state scene-id-path init-scene-id<span style="color: #8c8c8c;">)</span>
          specs<span style="color: #8c8c8c;">))</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline48">
<h2 id="orgheadline48">Some limitations</h2>
<ul>
<li>Anything that is not def'd, i.e anonymous functions, can not be re-evaluated while the game is running</li>
<li>Component functions rely heavily on higher order functions that return anonymous functions</li>
<li>Workaround is to use a component function as a light wrapper around smaller def'd functions</li>
<li>Maybe macros can help?</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline59">
<h2 id="orgheadline59">Performance tuning</h2>
<div class="outline-text-2" id="text-orgheadline59">
</div></section>
</section>
<section>
<section id="slide-orgheadline49">
<h3 id="orgheadline49">Variadic function signatures</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">foo</span> [x &amp; args]
  <span style="color: #8c8c8c;">(</span>body ..<span style="color: #8c8c8c;">))</span>
</pre>
</div>
<ul>
<li>Dynamic dispatching is not great in a tight loop</li>
<li>You should probably know what signature are going to be used anyway</li>
<li>Javascript compiler (V8) bails out and can't optimize</li>
<li>Use multiple arity functions instead</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline50">
<h3 id="orgheadline50">Multiple arity functions</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">foo</span>
  <span style="color: #8c8c8c;">(</span>[x]
   <span style="color: #8c8c8c;">(</span>foo x <span style="color: #ae81ff;">nil</span><span style="color: #8c8c8c;">))</span>
  <span style="color: #8c8c8c;">(</span>[x y]
   <span style="color: #8c8c8c;">(</span>bar x y<span style="color: #8c8c8c;">)))</span>
</pre>
</div>
<ul>
<li>Finite number arities, not infinite</li>
<li>Can be optimized by the compiler/runtime</li>
<li>Much faster</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline51">
<h3 id="orgheadline51">Avoid partials</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #8c8c8c;">(</span>apply <span style="color: #8c8c8c;">(</span>partial x<span style="color: #8c8c8c;">)</span> [y z]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline52">
<h3 id="orgheadline52">Empty checking</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #465457;">;; </span><span style="color: #465457;">Bad</span>
<span style="color: #8c8c8c;">(</span>empty? []<span style="color: #8c8c8c;">)</span>
<span style="color: #465457;">;; </span><span style="color: #465457;">Good</span>
<span style="color: #8c8c8c;">(</span>seq []<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</section>
</section>
<section>
<section id="slide-orgheadline53">
<h3 id="orgheadline53">Runtime polymorphism</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #465457;">;; </span><span style="color: #465457;">Bad</span>
<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defmulti</span> <span style="color: #a6e22e;">foo</span> (fn [&amp; args] ...<span style="color: #8c8c8c;">))</span>
<span style="color: #465457;">;; </span><span style="color: #465457;">Good, but less elegant</span>
<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">condp</span> = x
  ...<span style="color: #8c8c8c;">)</span>
<span style="color: #465457;">;; </span><span style="color: #465457;">Fastest??</span>
<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defprotocol</span> <span style="color: #66d9ef; font-weight: bold;">Fooable</span>
  <span style="color: #8c8c8c;">(</span>foo [this x]<span style="color: #8c8c8c;">))</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">deftype</span> <span style="color: #66d9ef; font-weight: bold;">Thing</span>
  <span style="color: #66d9ef; font-weight: bold;">Fooable</span>
  <span style="color: #8c8c8c;">(</span>foo [this x] ...<span style="color: #8c8c8c;">))</span>
</pre>
</div>
<ul>
<li>multimethods are too slow for a tight loop</li>
<li>condp compiles to a conditional that can be optimized</li>
<li>Protocols and types should be fastest, but static</li>
<li>Tradeoff speed vs dynamism</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline54">
<h3 id="orgheadline54">Literals</h3>
<div class="org-src-container">

<pre  class="src src-clojure"><span style="color: #465457;">;; </span><span style="color: #465457;">Vector 1 2 3 is constructed every time foo is called</span>
<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">foo</span> [x]
  <span style="color: #8c8c8c;">(</span>concat [x] [1 2 3]<span style="color: #8c8c8c;">))</span>
<span style="color: #465457;">;; </span><span style="color: #465457;">Skips the construction of a persistent vector each time</span>
<span style="color: #465457;">;; </span><span style="color: #465457;">foo is called</span>
<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">def</span> <span style="color: color-152;">one-two-three</span> [1 2 3]<span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #f92672; font-weight: bold;">defn</span> <span style="color: #a6e22e;">foo</span> [x]
  <span style="color: #8c8c8c;">(</span>concat [x] one-two-three<span style="color: #8c8c8c;">))</span>
</pre>
</div>
<ul>
<li>If it's hardcoded inside a function, then def it</li>
<li>In clojure, use the ^const type hint to have the compiler inline it</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline55">
<h3 id="orgheadline55">Lazyness</h3>
<ul>
<li>Most of the Clojure core is lazy map/for/concat/filter etc.</li>
<li>Game code is usually eager and inputs are finite</li>
<li>Favor reduce over map</li>
<li>Write your own for loop that does not use lazy-seq</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline56">
<h3 id="orgheadline56">ClojureScript specific</h3>
<ul>
<li>Clojure only evaluates false for nil and false, not null/undefined/NaN/""/0</li>
<li>If you already know it's a boolean, skip the extra checking with a typehint ^boolean</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline57">
<h3 id="orgheadline57">Immutability?</h3>
<ul>
<li>Tried to write my own data structure to take advantage of mutability</li>
<li>Mine was slower</li>
<li>Your's will probably be slower</li>
<li>Use a profiler, it's probably not this!</li>
<li>Use interop with the host environment if you really need</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline58">
<h3 id="orgheadline58">The slowest part is usually your implementation, not functional programming</h3>
</section>
</section>
<section>
<section id="slide-orgheadline60">
<h2 id="orgheadline60">The Functional Game Engine I'm Building</h2>
<ul>
<li>Chocolatier</li>
<li><a href="https://github.com/alexkehayias/chocolatier">https://github.com/alexkehayias/chocolatier</a></li>
<li>A functional, repl-driven, game engine targeting 2D games in the browser written in ClojureScript</li>
<li>Actively in development, not stable</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgheadline61">
<h2 id="orgheadline61">Let's make creating games sweeter!</h2>
<p>
Thank you!
@alexkehayias
<a href="https://github.com/alexkehayias/chocolatier">https://github.com/alexkehayias/chocolatier</a>
</p>
</section>
</section>
<section>
<section id="slide-orgheadline62">
<h2 id="orgheadline62">Resources</h2>
<ul>
<li>Scott Bilas (Dungeon Siege) GDC talk that started it all: <a href="http://t-machine.org/index.php/2007/12/22/entity-systems-are-the-future-of-mmog-development-part-3/">http://t-machine.org/index.php/2007/12/22/entity-systems-are-the-future-of-mmog-development-part-3/</a></li>
<li>Game Programming Patterns chapter on Components: <a href="http://gameprogrammingpatterns.com/component.html">http://gameprogrammingpatterns.com/component.html</a></li>
<li>Brian Bucklew (Qud, Sproggiwood) talk at IRDC US 2015: <a href="https://www.youtube.com/watch?v=U03XXzcThGU">https://www.youtube.com/watch?v=U03XXzcThGU</a></li>
<li>Adam Martin's blog series on ECS (kind of confusing): <a href="http://t-machine.org/index.php/2007/09/03/entity-systems-are-the-future-of-mmog-development-part-1/">http://t-machine.org/index.php/2007/09/03/entity-systems-are-the-future-of-mmog-development-part-1/</a></li>

</ul>
</section>
</section>
</div>
</div>
<p>Created by Alex Kehayias</p>
<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/head.min.js"></script>
<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: true,
rollingLinks: true,
keyboard: true,
overview: true,
width: 1140,
height: 900,
margin: 0.10,
minScale: 1.00,
maxScale: 2.50,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

});
</script>
</body>
</html>
